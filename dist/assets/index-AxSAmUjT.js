(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}})();let P,N=!1;const te=new Promise(e=>{P=e});function q(){var e,n,s,o;if(console.log("window.__TAURI__ available?",typeof window.__TAURI__),console.log("window.__TAURI__ keys:",window.__TAURI__?Object.keys(window.__TAURI__):"undefined"),!window.__TAURI__)return!1;window.Tauri||(window.Tauri={});try{if(window.Tauri.invoke=((e=window.__TAURI__.core)==null?void 0:e.invoke)||((n=window.__TAURI__.tauri)==null?void 0:n.invoke),window.Tauri.listen=(s=window.__TAURI__.event)==null?void 0:s.listen,window.Tauri.emit=(o=window.__TAURI__.event)==null?void 0:o.emit,window.__TAURI__.webviewWindow){const{WebviewWindow:i}=window.__TAURI__.webviewWindow;window.Tauri.appWindow=i.getCurrent()}else if(window.__TAURI__.window){const{getCurrent:i}=window.__TAURI__.window;window.Tauri.appWindow=i()}return N=!0,P(window.Tauri),!0}catch(i){return console.error("Error loading Tauri APIs:",i),!1}}q()||(window.addEventListener("tauri://ready",()=>{N||q()},{once:!0}),setTimeout(()=>{N||(console.warn("Tauri APIs not detected. Continuing without native bridge."),window.Tauri||(window.Tauri={}),P(window.Tauri))},2e3));function J(){return te}(function(){let e=null;J().then(()=>{var o,i,r,l,f;e=((o=window.Tauri)==null?void 0:o.invoke)||((r=(i=window.__TAURI__)==null?void 0:i.core)==null?void 0:r.invoke)||((f=(l=window.__TAURI__)==null?void 0:l.tauri)==null?void 0:f.invoke),e||console.error("SessionReview: Tauri invoke not available")}).catch(o=>{console.error("SessionReview: failed to initialize Tauri bridge",o)});class n{constructor(){this.isOpen=!1,this.sessionStartTime=null,this.entries=[],this.drawerEl=null,this.triggerBtn=null,this.closeBtn=null,this.entriesContainer=null,this.summaryEl=null,this.emptyStateEl=null,this.open=this.open.bind(this),this.close=this.close.bind(this),this.toggle=this.toggle.bind(this),this.refresh=this.refresh.bind(this),this.handleCheckInCreated=this.handleCheckInCreated.bind(this)}init(){if(this.drawerEl=document.getElementById("reviewDrawer"),this.triggerBtn=document.getElementById("reviewTrigger"),this.closeBtn=document.getElementById("reviewClose"),this.entriesContainer=document.getElementById("reviewEntries"),this.summaryEl=document.getElementById("reviewSummary"),this.emptyStateEl=document.getElementById("reviewEmptyState"),!this.drawerEl||!this.triggerBtn){console.error("Session review elements not found in DOM");return}this.triggerBtn.addEventListener("click",this.toggle),this.closeBtn&&this.closeBtn.addEventListener("click",this.close),window.addEventListener("ft:checkin-created",this.handleCheckInCreated),console.log("Session Review module initialized")}setSessionStartTime(i){this.sessionStartTime=i,console.log("Session start time set:",this.sessionStartTime.toISOString())}async open(){this.isOpen||(this.isOpen=!0,this.drawerEl.classList.add("open"),this.drawerEl.setAttribute("aria-expanded","true"),this.triggerBtn.setAttribute("aria-pressed","true"),await this.refresh())}close(){this.isOpen&&(this.isOpen=!1,this.drawerEl.classList.remove("open"),this.drawerEl.setAttribute("aria-expanded","false"),this.triggerBtn.setAttribute("aria-pressed","false"))}async toggle(){this.isOpen?this.close():await this.open()}async refresh(){if(!this.sessionStartTime){console.warn("Cannot refresh: session start time not set"),this.showEmptyState("No active session");return}if(!e){console.error("SessionReview: cannot refresh without Tauri invoke");return}try{const i=this.sessionStartTime.toISOString();this.entries=await e("list_session_entries",{startTimeIso:i}),console.log(`Loaded ${this.entries.length} session entries`),this.render()}catch(i){console.error("Failed to load session entries:",i),this.showError(`Unable to load session log: ${i}`)}}render(){if(!this.entriesContainer)return;if(!this.entries||this.entries.length===0){this.showEmptyState("No check-ins yet. Stay mindful ‚ú®");return}this.emptyStateEl&&(this.emptyStateEl.style.display="none");const i=document.createDocumentFragment();this.entries.forEach(r=>{const l=this.createEntryElement(r);i.appendChild(l)}),this.entriesContainer.innerHTML="",this.entriesContainer.appendChild(i),this.updateSummary()}createEntryElement(i){const r=document.createElement("div");r.className="review-entry";const f=new Date(i.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return r.innerHTML=`
                <div class="entry-header">
                    <span class="entry-status">${i.statusLabel}</span>
                    <span class="entry-time">${f}</span>
                </div>
                ${i.note?`<div class="entry-note">${this.escapeHtml(i.note)}</div>`:""}
            `,r}updateSummary(){if(!this.summaryEl)return;const i=this.entries.filter(f=>f.status==="On Task").length,r=this.entries.filter(f=>f.status==="Social Media"||f.status==="Email/Chat"||f.status==="Other Distraction").length,l=this.entries.filter(f=>f.status==="Taking a Break").length;this.summaryEl.innerHTML=`
                <span class="summary-stat">‚úÖ On Task: ${i}</span>
                <span class="summary-stat">üö´ Distracted: ${r}</span>
                <span class="summary-stat">‚òïÔ∏è Breaks: ${l}</span>
            `}showEmptyState(i){this.entriesContainer&&(this.entriesContainer.innerHTML=""),this.emptyStateEl&&(this.emptyStateEl.textContent=i,this.emptyStateEl.style.display="block"),this.summaryEl&&(this.summaryEl.innerHTML='<span class="summary-stat">No data yet</span>')}showError(i){this.showEmptyState(`‚ö†Ô∏è ${i}`)}handleCheckInCreated(){console.log("Check-in created event received"),this.isOpen&&this.refresh()}escapeHtml(i){const r=document.createElement("div");return r.textContent=i,r.innerHTML}reset(){this.sessionStartTime=null,this.entries=[],this.close(),this.showEmptyState("Session reset")}}const s=new n;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>s.init()):s.init(),window.sessionReview=s})();let y,D,z,k;const t={};let a={sessionDuration:720,checkInInterval:15,writeTime:20},m=a.sessionDuration*60,d=a.checkInInterval*60,v=0,h=!1,I=!1,O=0,S=!1,E=null,w=null,T=null,L=null,b=null,_=null,p=!1,c=null,u=null,M=0,F=!1;const ne=1e3,ie=6e4,se=15;async function R(){var e,n,s,o;if(!(y&&D&&z&&k)&&(await J(),y=(e=window.Tauri)==null?void 0:e.invoke,D=(n=window.Tauri)==null?void 0:n.listen,z=(s=window.Tauri)==null?void 0:s.emit,k=(o=window.Tauri)==null?void 0:o.appWindow,!y||!D||!k))throw new Error("Tauri APIs are not available. Run inside the Tauri shell.")}function oe(){t.timerLabel=document.getElementById("timerLabel"),t.timer=document.getElementById("timer"),t.status=document.getElementById("status"),t.sessionProgress=document.getElementById("sessionProgress"),t.checkIns=document.getElementById("checkIns"),t.startBtn=document.getElementById("startBtn"),t.resetBtn=document.getElementById("resetBtn"),t.settingsBtn=document.getElementById("settingsBtn"),t.testBtn=document.getElementById("testBtn"),t.calendarBtn=document.getElementById("calendarBtn"),t.sessionGoal=document.getElementById("sessionGoal"),t.mainScreen=document.getElementById("mainScreen"),t.checkInScreen=document.getElementById("checkInScreen"),t.checkInGoalText=document.getElementById("checkInGoalText"),t.checkInNotes=document.getElementById("checkInNotes"),t.checkInCountdown=document.getElementById("checkInCountdown"),t.focusShieldBtn=document.getElementById("focusShieldBtn"),t.focusShieldBanner=document.getElementById("focusShieldBanner"),t.focusShieldText=document.getElementById("focusShieldText"),t.focusShieldCancelBtn=document.getElementById("focusShieldCancelBtn")}function X(e){const n=Math.max(0,Math.round(e)),s=Math.floor(n/60),o=n%60;return`${s}:${o.toString().padStart(2,"0")}`}function re(e){return new Date(e).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}async function ae(){try{const e=await y("get_settings");a={sessionDuration:e.session_duration||a.sessionDuration,checkInInterval:e.check_in_interval||a.checkInInterval,writeTime:e.write_time||a.writeTime},console.log("Settings loaded:",a),!h&&!I&&(m=a.sessionDuration*60,d=a.checkInInterval*60)}catch(e){console.error("Failed to load settings:",e)}}function B(e=Date.now()){E&&(m=Math.max(0,Math.ceil((E-e)/1e3))),w&&(d=Math.max(0,Math.ceil((w-e)/1e3))),T&&(v=Math.max(0,Math.ceil((T-e)/1e3)))}function H(){L||(b=Date.now(),L=setInterval(()=>{ce().catch(e=>console.error("Tick loop failed:",e))},ne))}function $(e=!1){L&&(e||!h&&!I&&!p)&&(clearInterval(L),L=null,b=null)}function V(e){return p&&c&&e<c}function Y(e){w=(c||e)+a.checkInInterval*60*1e3,B(e),u="Check-in postponed",g()}function le(e){console.log(`Sleep detected: ${Math.round(e/1e3)}s delay`),h&&(G({reason:"sleep"}),u=`Paused: Mac was asleep for ${Math.round(e/6e4)} min`),C(),B()}async function ce(){const e=Date.now();if(b){const n=e-b;n>ie&&le(n)}if(b=e,p&&c&&e>=c&&(p=!1,c=null,u="Focus Shield ended",C()),I&&T&&(v=Math.max(0,Math.ceil((T-e)/1e3)),K(),v<=0)){ue();return}if(h){if(E&&(m=Math.max(0,Math.ceil((E-e)/1e3)),m<=0)){fe();return}if(w&&(d=Math.max(0,Math.ceil((w-e)/1e3)),d<=0)){V(e)?Y(e):await Z();return}}else I||B(e);g()}function C(){t.focusShieldBanner&&(p&&c?(t.focusShieldBanner.hidden=!1,document.querySelector(".app-shell").style.borderColor="rgba(255, 193, 7, 0.5)",t.focusShieldText&&(t.focusShieldText.textContent=`Shield active until ${re(c)}`),t.focusShieldBtn&&(t.focusShieldBtn.textContent="üõ°Ô∏è Extend",t.focusShieldBtn.style.color="#ffc107")):(t.focusShieldBanner.hidden=!0,document.querySelector(".app-shell").style.borderColor="",t.focusShieldBtn&&(t.focusShieldBtn.textContent="üõ°Ô∏è Focus Shield",t.focusShieldBtn.style.color="")))}async function g(){C();const e=t.timerLabel,n=t.timer,s=t.status;let o="";if(I)e&&(e.textContent="‚úçÔ∏è LOG ACTIVITY"),n&&(n.textContent=`${v}`),s&&(s.textContent="Write what you're doing"),o=`‚úçÔ∏è ${v}s`;else{e&&(e.textContent="NEXT CHECK-IN"),n&&(n.textContent=X(d));let l=h?"Session active":"Ready";p&&c&&(l=`Focus Shield ‚Ä¢ ${Math.max(1,Math.ceil((c-Date.now())/6e4))} min`),u&&(l=u,u=null),s&&(s.textContent=l),o=X(d)}const i=Math.max(0,a.sessionDuration*60-m),r=Math.floor(i/60);if(t.sessionProgress&&(t.sessionProgress.textContent=`${r}m / ${a.sessionDuration}m`),t.checkIns){let l=`${O}`;M>0&&(l+=` (${M} skip)`),t.checkIns.textContent=l}F&&(o="üî¥ "+o);try{await y("update_tray_timer",{timerText:o})}catch(l){console.error("Failed to update tray timer:",l)}}function j(){h?G({reason:"user"}):Q()}async function Q({autoHide:e=!0}={}){var s;const n=Date.now();if(!h&&!I&&((m<=0||m>a.sessionDuration*60)&&(m=a.sessionDuration*60),(d<=0||d>a.checkInInterval*60)&&(d=a.checkInInterval*60),window.sessionReview&&window.sessionReview.setSessionStartTime(new Date)),E=n+m*1e3,w=n+d*1e3,h=!0,t.startBtn&&(t.startBtn.textContent="Pause Focus",t.startBtn.style.background="rgba(255,255,255,0.1)",t.startBtn.style.color="#fff"),H(),g(),e)try{await R();const o=(s=window.Tauri)==null?void 0:s.appWindow;console.log("üîΩ Hiding window after Start...",o),o&&o.hide?(await o.hide(),console.log("‚úÖ Window hidden successfully")):console.error("‚ùå appWindow.hide not available. window.Tauri:",window.Tauri)}catch(o){console.error("‚ùå Failed to hide window:",o)}}function G({reason:e}={}){h&&(B(),h=!1,E=null,w=null,t.startBtn&&(t.startBtn.textContent="Resume Focus",t.startBtn.style.background="white",t.startBtn.style.color="black"),e==="user"&&(u="Session paused"),g(),$())}function U(){h=!1,I=!1,O=0,M=0,F=!1,m=a.sessionDuration*60,d=a.checkInInterval*60,v=0,E=null,w=null,T=null,p=!1,c=null,S=!1,ee(),$(!0),A(),x(),window.sessionReview&&window.sessionReview.reset(),t.sessionGoal&&(t.sessionGoal.placeholder="What are you trying to achieve?"),t.startBtn&&(t.startBtn.textContent="Start Focus",t.startBtn.style.background="white",t.startBtn.style.color="black"),u="Ready",g()}async function Z({forced:e=!1}={}){const n=Date.now();if(!e&&V(n)){Y(n);return}B(n),G({reason:"check-in"});try{await y("position_window_centered"),await k.show(),await k.setFocus()}catch(s){console.error("Failed to show window:",s)}de(),I=!0,v=a.writeTime,T=Date.now()+a.writeTime*1e3,O+=1,K(),H(),g()}function de(){var n,s,o;const e=(((n=t.sessionGoal)==null?void 0:n.value)||"").trim()||"(No specific goal)";t.checkInGoalText&&(t.checkInGoalText.textContent=`"${e}"`),t.checkInNotes&&(t.checkInNotes.value=""),(s=t.mainScreen)==null||s.classList.add("hidden"),(o=t.checkInScreen)==null||o.classList.add("active"),document.body.classList.add("check-in-active"),K()}function ee(){var e,n;(e=t.mainScreen)==null||e.classList.remove("hidden"),(n=t.checkInScreen)==null||n.classList.remove("active"),document.body.classList.remove("check-in-active")}function K(){t.checkInCountdown&&(t.checkInCountdown.textContent=`Resuming session in ${v}s...`)}function ue(){M++,F=!0,W("Skip",{auto:!0})}async function W(e,n={}){var o,i,r;if(!I)return;n.auto||(F=!1);const s={timestamp:new Date().toISOString(),session_goal:((o=t.sessionGoal)==null?void 0:o.value)||"",reported_status:e,notes:((i=t.checkInNotes)==null?void 0:i.value)||"",session_duration_setting:a.sessionDuration,check_in_interval_setting:a.checkInInterval,write_time_setting:a.writeTime,check_in_number:O,auto_submitted:!!n.auto,focus_shield_active:p};try{await y("log_check_in",{logLine:JSON.stringify(s)}),window.dispatchEvent(new CustomEvent("ft:checkin-created"))}catch(l){console.error("Failed to log check-in:",l)}try{await R();const l=(r=window.Tauri)==null?void 0:r.appWindow;console.log("üîΩ Hiding window after check-in response..."),l&&l.hide?(await l.hide(),console.log("‚úÖ Window hidden successfully")):console.error("‚ùå appWindow.hide not available. window.Tauri:",window.Tauri)}catch(l){console.error("‚ùå Failed to hide window:",l)}he({auto:n.auto,status:e})}function he({auto:e=!1,status:n}={}){I=!1,T=null,v=0,ee(),d=a.checkInInterval*60,w=Date.now()+d*1e3,e?u="Skipped":n?u=`Logged: ${n}`:u="Session active",g(),Q()}function fe(){G(),$(!0),alert("Session complete! Great work! üéâ"),U()}function we(){const e=Date.now(),n=se*60*1e3;if(p&&c&&c>e?(c+=n,u="Shield extended"):(c=e+n,u="Shield enabled"),p=!0,h&&w){const s=c+a.checkInInterval*60*1e3;w<s&&(w=s)}C(),H(),g()}function me(){p=!1,c=null,u="Shield off",C(),g(),$()}async function ye(){try{await y("open_settings")}catch(e){console.error("Failed to open settings:",e)}}async function pe(){await Z({forced:!0})}async function ge(){try{const e=await y("get_current_event");e?(t.sessionGoal&&(t.sessionGoal.value=e),S=!0,x(),Ie()):alert("No calendar event found for the current time.")}catch(e){alert(e||"Failed to access calendar.")}}function x(){const e=t.calendarBtn;e&&(S?(e.textContent="‚úÖ Synced",e.style.color="#48bb78"):(e.textContent="üìÖ Event",e.style.color=""))}function Ie(){_&&clearInterval(_),_=setInterval(async()=>{if(S)try{const e=await y("get_current_event");e&&t.sessionGoal&&t.sessionGoal.value!==e?t.sessionGoal.value=e:e||(t.sessionGoal&&(t.sessionGoal.placeholder="No current event"),S=!1,x(),A())}catch{}},6e4)}function A(){_&&(clearInterval(_),_=null)}document.addEventListener("keydown",async e=>{var n;if(e.key==="Escape"){try{await R();const s=(n=window.Tauri)==null?void 0:n.appWindow;console.log("üîΩ ESC pressed - hiding window..."),s&&s.hide&&(await s.hide(),console.log("‚úÖ Window hidden via ESC"))}catch(s){console.error("‚ùå Failed to hide window on ESC:",s)}return}if((e.metaKey||e.ctrlKey)&&e.shiftKey&&e.key==="I")try{await R(),await k.openDevtools()}catch{}});window.addEventListener("DOMContentLoaded",async()=>{await R(),oe(),C(),g();try{await y("position_window_centered")}catch(n){console.error("Failed to center window on startup:",n)}await k.onCloseRequested(async n=>{n.preventDefault(),await k.hide()}),t.startBtn&&t.startBtn.addEventListener("click",j),t.resetBtn&&t.resetBtn.addEventListener("click",U),t.settingsBtn&&t.settingsBtn.addEventListener("click",ye),t.testBtn&&t.testBtn.addEventListener("click",pe),t.calendarBtn&&t.calendarBtn.addEventListener("click",()=>{S?(S=!1,x(),A(),t.sessionGoal&&(t.sessionGoal.value="")):ge()}),t.focusShieldBtn&&t.focusShieldBtn.addEventListener("click",we),t.focusShieldCancelBtn&&t.focusShieldCancelBtn.addEventListener("click",me),document.querySelectorAll(".check-in-buttons button").forEach(n=>{n.addEventListener("click",()=>{W(n.getAttribute("data-status"))})}),t.checkInNotes&&t.checkInNotes.addEventListener("keypress",n=>{n.key==="Enter"&&W("On Task")}),t.sessionGoal&&(t.sessionGoal.addEventListener("keypress",n=>{n.key==="Enter"&&!h&&j()}),t.sessionGoal.addEventListener("input",n=>{S&&n.inputType&&(S=!1,x(),A())})),await ae(),U();const e=await D("settings-updated",n=>{if(n!=null&&n.payload){const s=n.payload;a={sessionDuration:s.session_duration||a.sessionDuration,checkInInterval:s.check_in_interval||a.checkInInterval,writeTime:s.write_time||a.writeTime};const o=Date.now();B(o),h&&(E=o+m*1e3,w=o+d*1e3),g()}});window.addEventListener("beforeunload",()=>e())});
