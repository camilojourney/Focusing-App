(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();let U,N=!1;const ie=new Promise(e=>{U=e});function z(){var e,i,s,o;if(console.log("window.__TAURI__ available?",typeof window.__TAURI__),console.log("window.__TAURI__ keys:",window.__TAURI__?Object.keys(window.__TAURI__):"undefined"),!window.__TAURI__)return!1;window.Tauri||(window.Tauri={});try{if(window.Tauri.invoke=((e=window.__TAURI__.core)==null?void 0:e.invoke)||((i=window.__TAURI__.tauri)==null?void 0:i.invoke),window.Tauri.listen=(s=window.__TAURI__.event)==null?void 0:s.listen,window.Tauri.emit=(o=window.__TAURI__.event)==null?void 0:o.emit,window.__TAURI__.webviewWindow){const{WebviewWindow:n}=window.__TAURI__.webviewWindow;window.Tauri.appWindow=n.getCurrent()}else if(window.__TAURI__.window){const{getCurrent:n}=window.__TAURI__.window;window.Tauri.appWindow=n()}return N=!0,U(window.Tauri),!0}catch(n){return console.error("Error loading Tauri APIs:",n),!1}}z()||(window.addEventListener("tauri://ready",()=>{N||z()},{once:!0}),setTimeout(()=>{N||(console.warn("Tauri APIs not detected. Continuing without native bridge."),window.Tauri||(window.Tauri={}),U(window.Tauri))},2e3));function j(){return ie}(function(){let e=null;j().then(()=>{var o,n,a,c,u;e=((o=window.Tauri)==null?void 0:o.invoke)||((a=(n=window.__TAURI__)==null?void 0:n.core)==null?void 0:a.invoke)||((u=(c=window.__TAURI__)==null?void 0:c.tauri)==null?void 0:u.invoke),e||console.error("SessionReview: Tauri invoke not available")}).catch(o=>{console.error("SessionReview: failed to initialize Tauri bridge",o)});class i{constructor(){this.isOpen=!1,this.sessionStartTime=null,this.entries=[],this.drawerEl=null,this.triggerBtn=null,this.closeBtn=null,this.entriesContainer=null,this.summaryEl=null,this.emptyStateEl=null,this.open=this.open.bind(this),this.close=this.close.bind(this),this.toggle=this.toggle.bind(this),this.refresh=this.refresh.bind(this),this.handleCheckInCreated=this.handleCheckInCreated.bind(this)}init(){if(this.drawerEl=document.getElementById("reviewDrawer"),this.triggerBtn=document.getElementById("reviewTrigger"),this.closeBtn=document.getElementById("reviewClose"),this.entriesContainer=document.getElementById("reviewEntries"),this.summaryEl=document.getElementById("reviewSummary"),this.emptyStateEl=document.getElementById("reviewEmptyState"),!this.drawerEl||!this.triggerBtn){console.error("Session review elements not found in DOM");return}this.triggerBtn.addEventListener("click",this.toggle),this.closeBtn&&this.closeBtn.addEventListener("click",this.close),window.addEventListener("ft:checkin-created",this.handleCheckInCreated),console.log("Session Review module initialized")}setSessionStartTime(n){this.sessionStartTime=n,console.log("Session start time set:",this.sessionStartTime.toISOString())}async open(){this.isOpen||(this.isOpen=!0,this.drawerEl.classList.add("open"),this.drawerEl.setAttribute("aria-expanded","true"),this.triggerBtn.setAttribute("aria-pressed","true"),await this.refresh())}close(){this.isOpen&&(this.isOpen=!1,this.drawerEl.classList.remove("open"),this.drawerEl.setAttribute("aria-expanded","false"),this.triggerBtn.setAttribute("aria-pressed","false"))}async toggle(){this.isOpen?this.close():await this.open()}async refresh(){if(!this.sessionStartTime){console.warn("Cannot refresh: session start time not set"),this.showEmptyState("No active session");return}if(!e){console.error("SessionReview: cannot refresh without Tauri invoke");return}try{const n=this.sessionStartTime.toISOString();this.entries=await e("list_session_entries",{startTimeIso:n}),console.log(`Loaded ${this.entries.length} session entries`),this.render()}catch(n){console.error("Failed to load session entries:",n),this.showError(`Unable to load session log: ${n}`)}}render(){if(!this.entriesContainer)return;if(!this.entries||this.entries.length===0){this.showEmptyState("No check-ins yet. Stay mindful ‚ú®");return}this.emptyStateEl&&(this.emptyStateEl.style.display="none");const n=document.createDocumentFragment();this.entries.forEach(a=>{const c=this.createEntryElement(a);n.appendChild(c)}),this.entriesContainer.innerHTML="",this.entriesContainer.appendChild(n),this.updateSummary()}createEntryElement(n){const a=document.createElement("div");a.className="review-entry";const u=new Date(n.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return a.innerHTML=`
                <div class="entry-header">
                    <span class="entry-status">${n.statusLabel}</span>
                    <span class="entry-time">${u}</span>
                </div>
                ${n.note?`<div class="entry-note">${this.escapeHtml(n.note)}</div>`:""}
            `,a}updateSummary(){if(!this.summaryEl)return;const n=this.entries.filter(u=>u.status==="On Task").length,a=this.entries.filter(u=>u.status==="Social Media"||u.status==="Email/Chat"||u.status==="Other Distraction").length,c=this.entries.filter(u=>u.status==="Taking a Break").length;this.summaryEl.innerHTML=`
                <span class="summary-stat">‚úÖ On Task: ${n}</span>
                <span class="summary-stat">üö´ Distracted: ${a}</span>
                <span class="summary-stat">‚òïÔ∏è Breaks: ${c}</span>
            `}showEmptyState(n){this.entriesContainer&&(this.entriesContainer.innerHTML=""),this.emptyStateEl&&(this.emptyStateEl.textContent=n,this.emptyStateEl.style.display="block"),this.summaryEl&&(this.summaryEl.innerHTML='<span class="summary-stat">No data yet</span>')}showError(n){this.showEmptyState(`‚ö†Ô∏è ${n}`)}handleCheckInCreated(){console.log("Check-in created event received"),this.isOpen&&this.refresh()}escapeHtml(n){const a=document.createElement("div");return a.textContent=n,a.innerHTML}reset(){this.sessionStartTime=null,this.entries=[],this.close(),this.showEmptyState("Session reset")}}const s=new i;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>s.init()):s.init(),window.sessionReview=s})();let g,x,K,I;const t={};let r={sessionDuration:720,checkInInterval:15,writeTime:20},f=r.sessionDuration*60,h=r.checkInInterval*60,E=0,l=!1,S=!1,L=0,v=!1,k=null,m=null,T=null,_=null,D=null,B=null,y=!1,d=null,w=null,M=0,O=!1;const se=1e3,oe=6e4,ae=15;async function C(){var e,i,s,o;if(!(g&&x&&K&&I)&&(await j(),g=(e=window.Tauri)==null?void 0:e.invoke,x=(i=window.Tauri)==null?void 0:i.listen,K=(s=window.Tauri)==null?void 0:s.emit,I=(o=window.Tauri)==null?void 0:o.appWindow,!g||!x||!I))throw new Error("Tauri APIs are not available. Run inside the Tauri shell.")}async function Y(e=""){var s;const i=e?` (${e})`:"";try{await C();const o=I||((s=window.Tauri)==null?void 0:s.appWindow);if(o!=null&&o.hide){await o.hide();return}}catch(o){console.error(`‚ùå Failed to hide window via JS${i}:`,o)}try{await g("hide_window")}catch(o){console.error(`‚ùå hide_window fallback failed${i}:`,o)}}function re(){t.timerLabel=document.getElementById("timerLabel"),t.timer=document.getElementById("timer"),t.status=document.getElementById("status"),t.sessionProgress=document.getElementById("sessionProgress"),t.checkIns=document.getElementById("checkIns"),t.startBtn=document.getElementById("startBtn"),t.resetBtn=document.getElementById("resetBtn"),t.settingsBtn=document.getElementById("settingsBtn"),t.testBtn=document.getElementById("testBtn"),t.calendarBtn=document.getElementById("calendarBtn"),t.sessionGoal=document.getElementById("sessionGoal"),t.mainScreen=document.getElementById("mainScreen"),t.checkInScreen=document.getElementById("checkInScreen"),t.checkInGoalText=document.getElementById("checkInGoalText"),t.checkInNotes=document.getElementById("checkInNotes"),t.checkInCountdown=document.getElementById("checkInCountdown"),t.focusShieldBtn=document.getElementById("focusShieldBtn"),t.focusShieldBanner=document.getElementById("focusShieldBanner"),t.focusShieldText=document.getElementById("focusShieldText"),t.focusShieldCancelBtn=document.getElementById("focusShieldCancelBtn"),t.winClose=document.getElementById("winClose"),t.winMinimize=document.getElementById("winMinimize")}function q(e){const i=Math.max(0,Math.round(e)),s=Math.floor(i/60),o=i%60;return`${s}:${o.toString().padStart(2,"0")}`}function ce(e){return new Date(e).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}async function le(){try{const e=await g("get_settings");r={sessionDuration:e.session_duration||r.sessionDuration,checkInInterval:e.check_in_interval||r.checkInInterval,writeTime:e.write_time||r.writeTime},console.log("Settings loaded:",r),!l&&!S&&(f=r.sessionDuration*60,h=r.checkInInterval*60)}catch(e){console.error("Failed to load settings:",e)}}function b(e=Date.now()){k&&(f=Math.max(0,Math.ceil((k-e)/1e3))),m&&(h=Math.max(0,Math.ceil((m-e)/1e3))),T&&(E=Math.max(0,Math.ceil((T-e)/1e3)))}function $(){_?console.log("startTicking: Tick interval already running"):(console.log("startTicking: Starting tick interval"),D=Date.now(),_=setInterval(()=>{ee().catch(e=>console.error("Tick loop failed:",e)),g("keep_app_alive").catch(()=>{})},se))}function W(e=!1){const i=e||!l&&!S&&!y;console.log("stopTickingIfIdle:",{force:e,isSessionRunning:l,isWriting:S,focusShieldActive:y,shouldStop:i,hasInterval:!!_}),_&&i&&(console.log("stopTickingIfIdle: Clearing tick interval"),clearInterval(_),_=null,D=null)}function Q(e){return y&&d&&e<d}function Z(e){m=(d||e)+r.checkInInterval*60*1e3,b(e),w="Check-in postponed",p()}function de(e){console.log(`Large time gap detected: ${Math.round(e/1e3)}s delay`),e>300*1e3&&l&&(P({reason:"sleep"}),w=`Paused: Mac was asleep for ${Math.round(e/6e4)} min`,R(),b())}async function ee(){const e=Date.now();if(D){const i=e-D;i>oe&&de(i)}if(D=e,y&&d&&e>=d&&(y=!1,d=null,w="Focus Shield ended",R()),S&&T&&(E=Math.max(0,Math.ceil((T-e)/1e3)),H(),E<=0)){fe();return}if(l){if(k&&(f=Math.max(0,Math.ceil((k-e)/1e3)),f<=0)){we();return}if(m&&(h=Math.max(0,Math.ceil((m-e)/1e3)),h<=0)){Q(e)?Z(e):await te();return}}else S||b(e);p()}function R(){t.focusShieldBanner&&(y&&d?(t.focusShieldBanner.hidden=!1,document.querySelector(".app-shell").style.borderColor="rgba(255, 193, 7, 0.5)",t.focusShieldText&&(t.focusShieldText.textContent=`Shield active until ${ce(d)}`),t.focusShieldBtn&&(t.focusShieldBtn.textContent="üõ°Ô∏è Extend",t.focusShieldBtn.style.color="#ffc107")):(t.focusShieldBanner.hidden=!0,document.querySelector(".app-shell").style.borderColor="",t.focusShieldBtn&&(t.focusShieldBtn.textContent="üõ°Ô∏è Focus Shield",t.focusShieldBtn.style.color="")))}async function p(){R();const e=t.timerLabel,i=t.timer,s=t.status;let o="";if(S)e&&(e.textContent="‚úçÔ∏è LOG ACTIVITY"),i&&(i.textContent=`${E}`),s&&(s.textContent="Write what you're doing"),o=`‚úçÔ∏è ${E}s`;else{e&&(e.textContent="NEXT CHECK-IN"),i&&(i.textContent=q(h));let c=l?"Session active":"Ready";y&&d&&(c=`Focus Shield ‚Ä¢ ${Math.max(1,Math.ceil((d-Date.now())/6e4))} min`),w&&(c=w,w=null),s&&(s.textContent=c),o=q(h)}const n=Math.max(0,r.sessionDuration*60-f),a=Math.floor(n/60);if(t.sessionProgress&&(t.sessionProgress.textContent=`${a}m / ${r.sessionDuration}m`),t.checkIns){let c=`${L}`;M>0&&(c+=` (${M} skip)`),t.checkIns.textContent=c}O&&(o="üî¥ "+o);try{await g("update_tray_timer",{timerText:o})}catch(c){console.error("Failed to update tray timer:",c)}}function J(){l?P({reason:"user"}):ue()}async function ue({autoHide:e=!0}={}){const i=Date.now();!l&&!S&&((f<=0||f>r.sessionDuration*60)&&(f=r.sessionDuration*60),(h<=0||h>r.checkInInterval*60)&&(h=r.checkInInterval*60),window.sessionReview&&window.sessionReview.setSessionStartTime(new Date)),k=i+f*1e3,m=i+h*1e3,l=!0,t.startBtn&&(t.startBtn.textContent="Pause Focus",t.startBtn.style.background="rgba(255,255,255,0.1)",t.startBtn.style.color="#fff"),$(),p(),e&&await Y("start focus")}function P({reason:e}={}){l&&(b(),l=!1,k=null,m=null,t.startBtn&&(t.startBtn.textContent="Resume Focus",t.startBtn.style.background="white",t.startBtn.style.color="black"),e==="user"&&(w="Session paused"),p(),W())}function V(){l=!1,S=!1,L=0,M=0,O=!1,f=r.sessionDuration*60,h=r.checkInInterval*60,E=0,k=null,m=null,T=null,y=!1,d=null,v=!1,ne(),W(!0),F(),A(),window.sessionReview&&window.sessionReview.reset(),t.sessionGoal&&(t.sessionGoal.placeholder="What are you trying to achieve?"),t.startBtn&&(t.startBtn.textContent="Start Focus",t.startBtn.style.background="white",t.startBtn.style.color="black"),w="Ready",p()}async function te({forced:e=!1}={}){console.log("triggerCheckIn: Starting check-in #"+(L+1));const i=Date.now();if(!e&&Q(i)){Z(i);return}b(i),S=!0,console.log("triggerCheckIn: Set isWriting=true BEFORE pauseSession"),P({reason:"check-in"});try{await g("position_window_centered"),await I.show(),await I.setFocus()}catch(s){console.error("Failed to show window:",s)}he(),E=r.writeTime,T=Date.now()+r.writeTime*1e3,L+=1,H(),$(),p()}function he(){var i,s,o;const e=(((i=t.sessionGoal)==null?void 0:i.value)||"").trim()||"(No specific goal)";t.checkInGoalText&&(t.checkInGoalText.textContent=`"${e}"`),t.checkInNotes&&(t.checkInNotes.value=""),(s=t.mainScreen)==null||s.classList.add("hidden"),(o=t.checkInScreen)==null||o.classList.add("active"),document.body.classList.add("check-in-active"),H()}function ne(){var e,i;(e=t.mainScreen)==null||e.classList.remove("hidden"),(i=t.checkInScreen)==null||i.classList.remove("active"),document.body.classList.remove("check-in-active")}function H(){t.checkInCountdown&&(t.checkInCountdown.textContent=`Resuming session in ${E}s...`)}function fe(){M++,O=!0,G("Skip",{auto:!0})}async function G(e,i={}){var o,n;if(!S)return;i.auto||(O=!1);const s={timestamp:new Date().toISOString(),session_goal:((o=t.sessionGoal)==null?void 0:o.value)||"",reported_status:e,notes:((n=t.checkInNotes)==null?void 0:n.value)||"",session_duration_setting:r.sessionDuration,check_in_interval_setting:r.checkInInterval,write_time_setting:r.writeTime,check_in_number:L,auto_submitted:!!i.auto,focus_shield_active:y};try{await g("log_check_in",{logLine:JSON.stringify(s)}),window.dispatchEvent(new CustomEvent("ft:checkin-created"))}catch(a){console.error("Failed to log check-in:",a)}await Y("check-in submit"),me({auto:i.auto,status:e})}async function me({auto:e=!1,status:i}={}){console.log("endWriteTime called, isSessionRunning before:",l),S=!1,T=null,E=0,ne(),h=r.checkInInterval*60;const s=Date.now();m=s+h*1e3,f>0&&(k=s+f*1e3),e?w="Skipped":i?w=`Logged: ${i}`:w="Session active",t.mainScreen&&t.mainScreen.classList.remove("hidden"),p(),l=!0,$(),console.log("endWriteTime done, isSessionRunning after:",l,"checkInEndTimestamp:",new Date(m).toLocaleTimeString(),"sessionEndTimestamp:",new Date(k).toLocaleTimeString())}function we(){L=0,M=0,O=!1,f=r.sessionDuration*60,h=r.checkInInterval*60;const e=Date.now();k=e+f*1e3,m=e+h*1e3,w="New cycle started",console.log("Session cycle complete, starting new cycle automatically"),p()}function ge(){const e=Date.now(),i=ae*60*1e3;if(y&&d&&d>e?(d+=i,w="Shield extended"):(d=e+i,w="Shield enabled"),y=!0,l&&m){const s=d+r.checkInInterval*60*1e3;m<s&&(m=s)}R(),$(),p()}function ye(){y=!1,d=null,w="Shield off",R(),p(),W()}async function pe(){try{await g("open_settings")}catch(e){console.error("Failed to open settings:",e)}}async function Ie(){await te({forced:!0})}async function X(e=!1){try{const i=await g("get_current_event");i?(t.sessionGoal&&(t.sessionGoal.value=i),v=!0,A(),Se()):e||alert("No calendar event found for the current time.")}catch(i){e||alert(i||"Failed to access calendar."),console.error("Calendar access failed:",i)}}function A(){const e=t.calendarBtn;e&&(v?(e.textContent="‚úÖ Synced",e.style.color="#48bb78"):(e.textContent="üìÖ Event",e.style.color=""))}function Se(){B&&clearInterval(B),B=setInterval(async()=>{if(v)try{const e=await g("get_current_event");e&&t.sessionGoal&&t.sessionGoal.value!==e?t.sessionGoal.value=e:e||(t.sessionGoal&&(t.sessionGoal.placeholder="No current event"),v=!1,A(),F())}catch{}},6e4)}function F(){B&&(clearInterval(B),B=null)}document.addEventListener("keydown",async e=>{var i;if(e.key==="Escape"){try{await C();const s=(i=window.Tauri)==null?void 0:i.appWindow;console.log("üîΩ ESC pressed - hiding window..."),s&&s.hide&&(await s.hide(),console.log("‚úÖ Window hidden via ESC"))}catch(s){console.error("‚ùå Failed to hide window on ESC:",s)}return}if((e.metaKey||e.ctrlKey)&&e.shiftKey&&e.key==="I")try{await C(),await I.openDevtools()}catch{}});window.addEventListener("DOMContentLoaded",async()=>{await C(),re(),R(),p();try{await g("position_window_centered")}catch(n){console.error("Failed to center window on startup:",n)}await I.onCloseRequested(async n=>{n.preventDefault(),await I.hide()}),t.startBtn&&t.startBtn.addEventListener("click",J),t.resetBtn&&t.resetBtn.addEventListener("click",V),t.settingsBtn&&t.settingsBtn.addEventListener("click",pe),t.testBtn&&t.testBtn.addEventListener("click",Ie),t.calendarBtn&&t.calendarBtn.addEventListener("click",()=>{v?(v=!1,A(),F(),t.sessionGoal&&(t.sessionGoal.value="")):X(!1)}),t.focusShieldBtn&&t.focusShieldBtn.addEventListener("click",ge),t.focusShieldCancelBtn&&t.focusShieldCancelBtn.addEventListener("click",ye);const e=document.getElementById("winClose"),i=document.getElementById("winMinimize");e&&e.addEventListener("click",async()=>{try{await C(),await I.hide()}catch(n){console.error("Failed to hide window:",n)}}),i&&i.addEventListener("click",async()=>{try{await C(),await I.minimize()}catch(n){console.error("Failed to minimize window:",n)}}),document.querySelectorAll(".check-in-buttons button").forEach(n=>{n.addEventListener("click",()=>{G(n.getAttribute("data-status"))})}),t.checkInNotes&&t.checkInNotes.addEventListener("keypress",n=>{n.key==="Enter"&&G("On Task")}),t.sessionGoal&&(t.sessionGoal.addEventListener("keypress",n=>{n.key==="Enter"&&!l&&J()}),t.sessionGoal.addEventListener("input",n=>{v&&n.inputType&&(v=!1,A(),F())})),await le(),V(),X(!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&l&&(console.log("Window became visible, ensuring timer is running"),ee().catch(n=>console.error("Visibility tick failed:",n)))});async function s(){try{await x("settings-updated",async n=>{if(console.log("Settings updated event received:",n.payload),currentSettings=n.payload,document.getElementById("startBtn").textContent==="Start Focus"){const u=n.payload.check_in_interval;document.getElementById("timer").textContent=`${String(u).padStart(2,"0")}:00`,console.log("Timer display updated to:",u,"minutes")}else console.log("Timer is running, settings will apply on next session")})}catch(n){console.error("Failed to setup settings listener:",n)}}s();const o=await x("settings-updated",n=>{if(n!=null&&n.payload){const a=n.payload;r={sessionDuration:a.session_duration||r.sessionDuration,checkInInterval:a.check_in_interval||r.checkInInterval,writeTime:a.write_time||r.writeTime};const c=Date.now();b(c),l&&(k=c+f*1e3,m=c+h*1e3),p()}});window.addEventListener("beforeunload",()=>o())});
