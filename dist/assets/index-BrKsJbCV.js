(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=o(s);fetch(s.href,a)}})();let U,N=!1;const ie=new Promise(e=>{U=e});function z(){var e,n,o,i;if(console.log("window.__TAURI__ available?",typeof window.__TAURI__),console.log("window.__TAURI__ keys:",window.__TAURI__?Object.keys(window.__TAURI__):"undefined"),!window.__TAURI__)return!1;window.Tauri||(window.Tauri={});try{if(window.Tauri.invoke=((e=window.__TAURI__.core)==null?void 0:e.invoke)||((n=window.__TAURI__.tauri)==null?void 0:n.invoke),window.Tauri.listen=(o=window.__TAURI__.event)==null?void 0:o.listen,window.Tauri.emit=(i=window.__TAURI__.event)==null?void 0:i.emit,window.__TAURI__.webviewWindow){const{WebviewWindow:s}=window.__TAURI__.webviewWindow;window.Tauri.appWindow=s.getCurrent()}else if(window.__TAURI__.window){const{getCurrent:s}=window.__TAURI__.window;window.Tauri.appWindow=s()}return N=!0,U(window.Tauri),!0}catch(s){return console.error("Error loading Tauri APIs:",s),!1}}z()||(window.addEventListener("tauri://ready",()=>{N||z()},{once:!0}),setTimeout(()=>{N||(console.warn("Tauri APIs not detected. Continuing without native bridge."),window.Tauri||(window.Tauri={}),U(window.Tauri))},2e3));function j(){return ie}(function(){let e=null;j().then(()=>{var i,s,a,c,w;e=((i=window.Tauri)==null?void 0:i.invoke)||((a=(s=window.__TAURI__)==null?void 0:s.core)==null?void 0:a.invoke)||((w=(c=window.__TAURI__)==null?void 0:c.tauri)==null?void 0:w.invoke),e||console.error("SessionReview: Tauri invoke not available")}).catch(i=>{console.error("SessionReview: failed to initialize Tauri bridge",i)});class n{constructor(){this.isOpen=!1,this.sessionStartTime=null,this.entries=[],this.drawerEl=null,this.triggerBtn=null,this.closeBtn=null,this.entriesContainer=null,this.summaryEl=null,this.emptyStateEl=null,this.open=this.open.bind(this),this.close=this.close.bind(this),this.toggle=this.toggle.bind(this),this.refresh=this.refresh.bind(this),this.handleCheckInCreated=this.handleCheckInCreated.bind(this)}init(){if(this.drawerEl=document.getElementById("reviewDrawer"),this.triggerBtn=document.getElementById("reviewTrigger"),this.closeBtn=document.getElementById("reviewClose"),this.entriesContainer=document.getElementById("reviewEntries"),this.summaryEl=document.getElementById("reviewSummary"),this.emptyStateEl=document.getElementById("reviewEmptyState"),!this.drawerEl||!this.triggerBtn){console.error("Session review elements not found in DOM");return}this.triggerBtn.addEventListener("click",this.toggle),this.closeBtn&&this.closeBtn.addEventListener("click",this.close),window.addEventListener("ft:checkin-created",this.handleCheckInCreated),console.log("Session Review module initialized")}setSessionStartTime(s){this.sessionStartTime=s,console.log("Session start time set:",this.sessionStartTime.toISOString())}async open(){this.isOpen||(this.isOpen=!0,this.drawerEl.classList.add("open"),this.drawerEl.setAttribute("aria-expanded","true"),this.triggerBtn.setAttribute("aria-pressed","true"),await this.refresh())}close(){this.isOpen&&(this.isOpen=!1,this.drawerEl.classList.remove("open"),this.drawerEl.setAttribute("aria-expanded","false"),this.triggerBtn.setAttribute("aria-pressed","false"))}async toggle(){this.isOpen?this.close():await this.open()}async refresh(){if(!this.sessionStartTime){console.warn("Cannot refresh: session start time not set"),this.showEmptyState("No active session");return}if(!e){console.error("SessionReview: cannot refresh without Tauri invoke");return}try{const s=this.sessionStartTime.toISOString();this.entries=await e("list_session_entries",{startTimeIso:s}),console.log(`Loaded ${this.entries.length} session entries`),this.render()}catch(s){console.error("Failed to load session entries:",s),this.showError(`Unable to load session log: ${s}`)}}render(){if(!this.entriesContainer)return;if(!this.entries||this.entries.length===0){this.showEmptyState("No check-ins yet. Stay mindful ‚ú®");return}this.emptyStateEl&&(this.emptyStateEl.style.display="none");const s=document.createDocumentFragment();this.entries.forEach(a=>{const c=this.createEntryElement(a);s.appendChild(c)}),this.entriesContainer.innerHTML="",this.entriesContainer.appendChild(s),this.updateSummary()}createEntryElement(s){const a=document.createElement("div");a.className="review-entry";const w=new Date(s.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return a.innerHTML=`
                <div class="entry-header">
                    <span class="entry-status">${s.statusLabel}</span>
                    <span class="entry-time">${w}</span>
                </div>
                ${s.note?`<div class="entry-note">${this.escapeHtml(s.note)}</div>`:""}
            `,a}updateSummary(){if(!this.summaryEl)return;const s=this.entries.filter(w=>w.status==="On Task").length,a=this.entries.filter(w=>w.status==="Social Media"||w.status==="Email/Chat"||w.status==="Other Distraction").length,c=this.entries.filter(w=>w.status==="Taking a Break").length;this.summaryEl.innerHTML=`
                <span class="summary-stat">‚úÖ On Task: ${s}</span>
                <span class="summary-stat">üö´ Distracted: ${a}</span>
                <span class="summary-stat">‚òïÔ∏è Breaks: ${c}</span>
            `}showEmptyState(s){this.entriesContainer&&(this.entriesContainer.innerHTML=""),this.emptyStateEl&&(this.emptyStateEl.textContent=s,this.emptyStateEl.style.display="block"),this.summaryEl&&(this.summaryEl.innerHTML='<span class="summary-stat">No data yet</span>')}showError(s){this.showEmptyState(`‚ö†Ô∏è ${s}`)}handleCheckInCreated(){console.log("Check-in created event received"),this.isOpen&&this.refresh()}escapeHtml(s){const a=document.createElement("div");return a.textContent=s,a.innerHTML}reset(){this.sessionStartTime=null,this.entries=[],this.close(),this.showEmptyState("Session reset")}}const o=new n;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>o.init()):o.init(),window.sessionReview=o})();let g,O,K,I;const t={};let r={sessionDuration:720,checkInInterval:15,writeTime:20},h=r.sessionDuration*60,u=r.checkInInterval*60,E=0,l=!1,S=!1,L=0,v=!1,k=null,f=null,T=null,_=null,x=null,B=null,y=!1,d=null,m=null,D=0,A=!1;const se=1e3,oe=6e4,ae=15;async function C(){var e,n,o,i;if(!(g&&O&&K&&I)&&(await j(),g=(e=window.Tauri)==null?void 0:e.invoke,O=(n=window.Tauri)==null?void 0:n.listen,K=(o=window.Tauri)==null?void 0:o.emit,I=(i=window.Tauri)==null?void 0:i.appWindow,!g||!O||!I))throw new Error("Tauri APIs are not available. Run inside the Tauri shell.")}async function Y(e=""){var o;const n=e?` (${e})`:"";try{await C();const i=I||((o=window.Tauri)==null?void 0:o.appWindow);if(i!=null&&i.hide){await i.hide();return}}catch(i){console.error(`‚ùå Failed to hide window via JS${n}:`,i)}try{await g("hide_window")}catch(i){console.error(`‚ùå hide_window fallback failed${n}:`,i)}}function re(){t.timerLabel=document.getElementById("timerLabel"),t.timer=document.getElementById("timer"),t.status=document.getElementById("status"),t.sessionProgress=document.getElementById("sessionProgress"),t.checkIns=document.getElementById("checkIns"),t.startBtn=document.getElementById("startBtn"),t.resetBtn=document.getElementById("resetBtn"),t.settingsBtn=document.getElementById("settingsBtn"),t.testBtn=document.getElementById("testBtn"),t.calendarBtn=document.getElementById("calendarBtn"),t.sessionGoal=document.getElementById("sessionGoal"),t.mainScreen=document.getElementById("mainScreen"),t.checkInScreen=document.getElementById("checkInScreen"),t.checkInGoalText=document.getElementById("checkInGoalText"),t.checkInNotes=document.getElementById("checkInNotes"),t.checkInCountdown=document.getElementById("checkInCountdown"),t.focusShieldBtn=document.getElementById("focusShieldBtn"),t.focusShieldBanner=document.getElementById("focusShieldBanner"),t.focusShieldText=document.getElementById("focusShieldText"),t.focusShieldCancelBtn=document.getElementById("focusShieldCancelBtn"),t.winClose=document.getElementById("winClose"),t.winMinimize=document.getElementById("winMinimize")}function q(e){const n=Math.max(0,Math.round(e)),o=Math.floor(n/60),i=n%60;return`${o}:${i.toString().padStart(2,"0")}`}function ce(e){return new Date(e).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}async function le(){try{const e=await g("get_settings");r={sessionDuration:e.session_duration||r.sessionDuration,checkInInterval:e.check_in_interval||r.checkInInterval,writeTime:e.write_time||r.writeTime},console.log("Settings loaded:",r),!l&&!S&&(h=r.sessionDuration*60,u=r.checkInInterval*60)}catch(e){console.error("Failed to load settings:",e)}}function b(e=Date.now()){k&&(h=Math.max(0,Math.ceil((k-e)/1e3))),f&&(u=Math.max(0,Math.ceil((f-e)/1e3))),T&&(E=Math.max(0,Math.ceil((T-e)/1e3)))}function F(){_?console.log("startTicking: Tick interval already running"):(console.log("startTicking: Starting tick interval"),x=Date.now(),_=setInterval(()=>{ee().catch(e=>console.error("Tick loop failed:",e)),g("keep_app_alive").catch(()=>{})},se))}function W(e=!1){const n=e||!l&&!S&&!y;console.log("stopTickingIfIdle:",{force:e,isSessionRunning:l,isWriting:S,focusShieldActive:y,shouldStop:n,hasInterval:!!_}),_&&n&&(console.log("stopTickingIfIdle: Clearing tick interval"),clearInterval(_),_=null,x=null)}function Q(e){return y&&d&&e<d}function Z(e){f=(d||e)+r.checkInInterval*60*1e3,b(e),m="Check-in postponed",p()}function de(e){console.log(`Large time gap detected: ${Math.round(e/1e3)}s delay`),e>300*1e3&&l&&(P({reason:"sleep"}),m=`Paused: Mac was asleep for ${Math.round(e/6e4)} min`,R(),b())}async function ee(){const e=Date.now();if(x){const n=e-x;n>oe&&de(n)}if(x=e,y&&d&&e>=d&&(y=!1,d=null,m="Focus Shield ended",R()),S&&T&&(E=Math.max(0,Math.ceil((T-e)/1e3)),H(),E<=0)){fe();return}if(l){if(k&&(h=Math.max(0,Math.ceil((k-e)/1e3)),h<=0)){we();return}if(f&&(u=Math.max(0,Math.ceil((f-e)/1e3)),u<=0)){Q(e)?Z(e):await te();return}}else S||b(e);p()}function R(){t.focusShieldBanner&&(y&&d?(t.focusShieldBanner.hidden=!1,document.querySelector(".app-shell").style.borderColor="rgba(255, 193, 7, 0.5)",t.focusShieldText&&(t.focusShieldText.textContent=`Shield active until ${ce(d)}`),t.focusShieldBtn&&(t.focusShieldBtn.textContent="üõ°Ô∏è Extend",t.focusShieldBtn.style.color="#ffc107")):(t.focusShieldBanner.hidden=!0,document.querySelector(".app-shell").style.borderColor="",t.focusShieldBtn&&(t.focusShieldBtn.textContent="üõ°Ô∏è Focus Shield",t.focusShieldBtn.style.color="")))}async function p(){R();const e=t.timerLabel,n=t.timer,o=t.status;let i="";if(S)e&&(e.textContent="‚úçÔ∏è LOG ACTIVITY"),n&&(n.textContent=`${E}`),o&&(o.textContent="Write what you're doing"),i=`‚úçÔ∏è ${E}s`;else{e&&(e.textContent="NEXT CHECK-IN"),n&&(n.textContent=q(u));let c=l?"Session active":"Ready";y&&d&&(c=`Focus Shield ‚Ä¢ ${Math.max(1,Math.ceil((d-Date.now())/6e4))} min`),m&&(c=m,m=null),o&&(o.textContent=c),i=q(u)}const s=Math.max(0,r.sessionDuration*60-h),a=Math.floor(s/60);if(t.sessionProgress&&(t.sessionProgress.textContent=`${a}m / ${r.sessionDuration}m`),t.checkIns){let c=`${L}`;D>0&&(c+=` (${D} skip)`),t.checkIns.textContent=c}A&&(i="üî¥ "+i);try{await g("update_tray_timer",{timerText:i})}catch(c){console.error("Failed to update tray timer:",c)}}function J(){l?P({reason:"user"}):ue()}async function ue({autoHide:e=!0}={}){const n=Date.now();!l&&!S&&((h<=0||h>r.sessionDuration*60)&&(h=r.sessionDuration*60),(u<=0||u>r.checkInInterval*60)&&(u=r.checkInInterval*60),window.sessionReview&&window.sessionReview.setSessionStartTime(new Date)),k=n+h*1e3,f=n+u*1e3,l=!0,t.startBtn&&(t.startBtn.textContent="Pause Focus",t.startBtn.style.background="rgba(255,255,255,0.1)",t.startBtn.style.color="#fff"),F(),p(),e&&await Y("start focus")}function P({reason:e}={}){l&&(b(),l=!1,k=null,f=null,t.startBtn&&(t.startBtn.textContent="Resume Focus",t.startBtn.style.background="white",t.startBtn.style.color="black"),e==="user"&&(m="Session paused"),p(),W())}function V(){l=!1,S=!1,L=0,D=0,A=!1,h=r.sessionDuration*60,u=r.checkInInterval*60,E=0,k=null,f=null,T=null,y=!1,d=null,v=!1,ne(),W(!0),$(),M(),window.sessionReview&&window.sessionReview.reset(),t.sessionGoal&&(t.sessionGoal.placeholder="What are you trying to achieve?"),t.startBtn&&(t.startBtn.textContent="Start Focus",t.startBtn.style.background="white",t.startBtn.style.color="black"),m="Ready",p()}async function te({forced:e=!1}={}){console.log("triggerCheckIn: Starting check-in #"+(L+1));const n=Date.now();if(!e&&Q(n)){Z(n);return}b(n),S=!0,console.log("triggerCheckIn: Set isWriting=true BEFORE pauseSession"),P({reason:"check-in"});try{await g("position_window_centered"),await I.show(),await I.setFocus()}catch(o){console.error("Failed to show window:",o)}he(),E=r.writeTime,T=Date.now()+r.writeTime*1e3,L+=1,H(),F(),p()}function he(){var n,o,i;const e=(((n=t.sessionGoal)==null?void 0:n.value)||"").trim()||"(No specific goal)";t.checkInGoalText&&(t.checkInGoalText.textContent=`"${e}"`),t.checkInNotes&&(t.checkInNotes.value=""),(o=t.mainScreen)==null||o.classList.add("hidden"),(i=t.checkInScreen)==null||i.classList.add("active"),document.body.classList.add("check-in-active"),H()}function ne(){var e,n;(e=t.mainScreen)==null||e.classList.remove("hidden"),(n=t.checkInScreen)==null||n.classList.remove("active"),document.body.classList.remove("check-in-active")}function H(){t.checkInCountdown&&(t.checkInCountdown.textContent=`Resuming session in ${E}s...`)}function fe(){D++,A=!0,G("Skip",{auto:!0})}async function G(e,n={}){var i,s;if(!S)return;n.auto||(A=!1);const o={timestamp:new Date().toISOString(),session_goal:((i=t.sessionGoal)==null?void 0:i.value)||"",reported_status:e,notes:((s=t.checkInNotes)==null?void 0:s.value)||"",session_duration_setting:r.sessionDuration,check_in_interval_setting:r.checkInInterval,write_time_setting:r.writeTime,check_in_number:L,auto_submitted:!!n.auto,focus_shield_active:y};try{await g("log_check_in",{logLine:JSON.stringify(o)}),window.dispatchEvent(new CustomEvent("ft:checkin-created"))}catch(a){console.error("Failed to log check-in:",a)}await Y("check-in submit"),me({auto:n.auto,status:e})}async function me({auto:e=!1,status:n}={}){console.log("endWriteTime called, isSessionRunning before:",l),S=!1,T=null,E=0,ne(),u=r.checkInInterval*60;const o=Date.now();f=o+u*1e3,h>0&&(k=o+h*1e3),e?m="Skipped":n?m=`Logged: ${n}`:m="Session active",t.mainScreen&&t.mainScreen.classList.remove("hidden"),p(),l=!0,F(),console.log("endWriteTime done, isSessionRunning after:",l,"checkInEndTimestamp:",new Date(f).toLocaleTimeString(),"sessionEndTimestamp:",new Date(k).toLocaleTimeString())}function we(){L=0,D=0,A=!1,h=r.sessionDuration*60,u=r.checkInInterval*60;const e=Date.now();k=e+h*1e3,f=e+u*1e3,m="New cycle started",console.log("Session cycle complete, starting new cycle automatically"),p()}function ge(){const e=Date.now(),n=ae*60*1e3;if(y&&d&&d>e?(d+=n,m="Shield extended"):(d=e+n,m="Shield enabled"),y=!0,l&&f){const o=d+r.checkInInterval*60*1e3;f<o&&(f=o)}R(),F(),p()}function ye(){y=!1,d=null,m="Shield off",R(),p(),W()}async function pe(){try{await g("open_settings")}catch(e){console.error("Failed to open settings:",e)}}async function Ie(){await te({forced:!0})}async function X(e=!1){try{const n=await g("get_current_event");n?(t.sessionGoal&&(t.sessionGoal.value=n),v=!0,M(),Se()):e||alert("No calendar event found for the current time.")}catch(n){e||alert(n||"Failed to access calendar."),console.error("Calendar access failed:",n)}}function M(){const e=t.calendarBtn;e&&(v?(e.textContent="‚úÖ Synced",e.style.color="#48bb78"):(e.textContent="üìÖ Event",e.style.color=""))}function Se(){B&&clearInterval(B),B=setInterval(async()=>{if(v)try{const e=await g("get_current_event");e&&t.sessionGoal&&t.sessionGoal.value!==e?t.sessionGoal.value=e:e||(t.sessionGoal&&(t.sessionGoal.placeholder="No current event"),v=!1,M(),$())}catch{}},6e4)}function $(){B&&(clearInterval(B),B=null)}document.addEventListener("keydown",async e=>{var n;if(e.key==="Escape"){try{await C();const o=(n=window.Tauri)==null?void 0:n.appWindow;console.log("üîΩ ESC pressed - hiding window..."),o&&o.hide&&(await o.hide(),console.log("‚úÖ Window hidden via ESC"))}catch(o){console.error("‚ùå Failed to hide window on ESC:",o)}return}if((e.metaKey||e.ctrlKey)&&e.shiftKey&&e.key==="I")try{await C(),await I.openDevtools()}catch{}});window.addEventListener("DOMContentLoaded",async()=>{await C(),re(),R(),p();try{await g("position_window_centered")}catch(i){console.error("Failed to center window on startup:",i)}await I.onCloseRequested(async i=>{i.preventDefault(),await I.hide()}),t.startBtn&&t.startBtn.addEventListener("click",J),t.resetBtn&&t.resetBtn.addEventListener("click",V),t.settingsBtn&&t.settingsBtn.addEventListener("click",pe),t.testBtn&&t.testBtn.addEventListener("click",Ie),t.calendarBtn&&t.calendarBtn.addEventListener("click",()=>{v?(v=!1,M(),$(),t.sessionGoal&&(t.sessionGoal.value="")):X(!1)}),t.focusShieldBtn&&t.focusShieldBtn.addEventListener("click",ge),t.focusShieldCancelBtn&&t.focusShieldCancelBtn.addEventListener("click",ye);const e=document.getElementById("winClose"),n=document.getElementById("winMinimize");e&&e.addEventListener("click",async()=>{try{await C(),await I.hide()}catch(i){console.error("Failed to hide window:",i)}}),n&&n.addEventListener("click",async()=>{try{await C(),await I.minimize()}catch(i){console.error("Failed to minimize window:",i)}}),document.querySelectorAll(".check-in-buttons button").forEach(i=>{i.addEventListener("click",()=>{G(i.getAttribute("data-status"))})}),t.checkInNotes&&t.checkInNotes.addEventListener("keypress",i=>{i.key==="Enter"&&G("On Task")}),t.sessionGoal&&(t.sessionGoal.addEventListener("keypress",i=>{i.key==="Enter"&&!l&&J()}),t.sessionGoal.addEventListener("input",i=>{v&&i.inputType&&(v=!1,M(),$())})),await le(),V(),X(!0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&l&&(console.log("Window became visible, ensuring timer is running"),ee().catch(i=>console.error("Visibility tick failed:",i)))});const o=await O("settings-updated",i=>{if(i!=null&&i.payload){const s=i.payload;r={sessionDuration:s.session_duration||r.sessionDuration,checkInInterval:s.check_in_interval||r.checkInInterval,writeTime:s.write_time||r.writeTime};const a=Date.now();b(a),l&&(k=a+h*1e3,f=a+u*1e3),p()}});window.addEventListener("beforeunload",()=>o())});
